<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mahender, Your AI Assistant!</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Baloo+Chettan+2:wght@400;600;700&display=swap');

        body {
            font-family: 'Baloo Chettan 2', cursive; /* More playful font */
            background: linear-gradient(135deg, #a7e6ff 0%, #d0f4ff 100%); /* Soft blue gradient */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
            transition: background 0.5s ease; /* Smooth transition for dark mode */
        }
        /* Dark mode styles */
        body.dark {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%); /* Darker gradient */
        }

        .container {
            background-color: #ffffff;
            border-radius: 2rem; /* Even more rounded corners */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); /* Slightly stronger, playful shadow */
            padding: 3rem;
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            border: 4px solid #818cf8; /* A fun border */
            position: relative; /* For speech bubble elements if needed */
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        /* Dark mode container */
        body.dark .container {
            background-color: #2b3a4a; /* Darker background */
            border-color: #6366f1; /* Darker border */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }

        .container::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #f97316, #fbbf24); /* Warm gradient icon placeholder */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            color: white;
            box-shadow: 0 5px 15px rgba(249, 115, 22, 0.5);
            animation: bounce 2s infinite;
            transition: background 0.5s ease, box-shadow 0.5s ease;
        }
        body.dark .container::before {
             background: linear-gradient(45deg, #6b21a8, #c026d3); /* Darker, vibrant purple */
             box-shadow: 0 5px 15px rgba(107, 33, 168, 0.5);
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateX(-50%) translateY(0);
            }
            50% {
                transform: translateX(-50%) translateY(-15px);
            }
        }
        .message-box {
            background-color: #e2e8f0; /* Light gray for messages */
            border-radius: 1rem; /* More rounded bubbles */
            padding: 1rem 1.5rem;
            color: #334155;
            font-size: 1.05rem; /* Slightly larger font */
            line-height: 1.6;
            word-wrap: break-word; /* Ensure long words wrap */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* Subtle bubble shadow */
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        body.dark .message-box {
            background-color: #4b5563; /* Darker gray */
            color: #d1d5db; /* Lighter text */
        }

        .user-message {
            background-color: #a5b4fc; /* Playful blue for user messages */
            color: #312e81; /* Darker blue text */
            align-self: flex-end; /* Align user messages to the right */
            text-align: right;
            border-bottom-right-radius: 0.25rem; /* Pointy tail effect */
        }
        body.dark .user-message {
            background-color: #4f46e5; /* Darker blue */
            color: #e0e7ff; /* Lighter text */
        }

        .ai-message {
            background-color: #99f6e4; /* Playful green for AI messages */
            color: #064e3b; /* Darker green text */
            align-self: flex-start; /* Align AI messages to the left */
            text-align: left;
            border-bottom-left-radius: 0.25rem; /* Pointy tail effect */
        }
        body.dark .ai-message {
            background-color: #10b981; /* Darker green */
            color: #ecfdf5; /* Lighter text */
        }

        /* Custom styling for the microphone button */
        .microphone-btn {
            background: linear-gradient(45deg, #4f46e5, #8b5cf6); /* Vibrant indigo-purple gradient */
            color: white;
            border: none;
            border-radius: 9999px; /* Fully circular */
            width: 70px; /* Even larger button */
            height: 70px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.2rem; /* Larger icon */
            cursor: pointer;
            transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 6px 15px rgba(79, 70, 229, 0.5); /* Enhanced indigo shadow */
            animation: none; /* Reset animation to prevent conflict */
        }
        .microphone-btn:hover {
            background: linear-gradient(45deg, #4338ca, #7c3aed); /* Darker gradient on hover */
            transform: translateY(-3px) scale(1.05); /* More pronounced lift and slight scale */
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.7);
        }
        .microphone-btn:active {
            transform: translateY(0) scale(1);
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.4);
        }
        .microphone-btn.listening {
            background: linear-gradient(45deg, #ef4444, #f87171); /* Red gradient when listening */
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: pulse-red 1.5s infinite; /* Pulsing animation */
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); /* Larger pulse */
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* Custom styling for the stop button */
        .stop-btn {
            background: linear-gradient(45deg, #dc2626, #ef4444); /* Red gradient */
            color: white;
            border: none;
            border-radius: 9999px; /* Fully circular */
            width: 55px; /* Slightly smaller than mic for hierarchy */
            height: 55px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(220, 38, 38, 0.4); /* Red shadow */
        }
        .stop-btn:hover {
            background: linear-gradient(45deg, #b91c1c, #dc2626); /* Darker red on hover */
            transform: translateY(-2px); /* Slight lift */
            box-shadow: 0 6px 15px rgba(220, 38, 38, 0.6);
        }
        .stop-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(220, 38, 38, 0.4);
        }
        .stop-btn:disabled {
            background: linear-gradient(45deg, #fca5a5, #fed7aa); /* Light pastel red when disabled */
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Custom styling for the listen again button */
        .listen-again-btn {
            background: linear-gradient(45deg, #22c55e, #86efac); /* Green gradient */
            color: white;
            border: none;
            border-radius: 9999px; /* Fully circular */
            width: 55px; /* Same size as stop button */
            height: 55px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(34, 197, 94, 0.4); /* Green shadow */
        }
        .listen-again-btn:hover {
            background: linear-gradient(45deg, #16a34a, #22c55e); /* Darker green on hover */
            transform: translateY(-2px); /* Slight lift */
            box-shadow: 0 6px 15px rgba(34, 197, 94, 0.6);
        }
        .listen-again-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(34, 197, 94, 0.4);
        }
        .listen-again-btn:disabled {
            background: linear-gradient(45deg, #bbf7d0, #dcfce7); /* Light pastel green when disabled */
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Dark mode toggle button */
        #darkModeToggle {
            background: linear-gradient(45deg, #6366f1, #a855f7); /* Purple gradient */
            color: white;
            border: none;
            border-radius: 9999px; /* Fully circular */
            width: 45px; /* Smaller toggle */
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 3px 8px rgba(99, 102, 241, 0.4);
            position: absolute; /* Position it top-right */
            top: 1rem;
            right: 1rem;
            z-index: 10;
        }
        #darkModeToggle:hover {
            background: linear-gradient(45deg, #4f46e5, #9333ea);
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.6);
        }
        body.dark #darkModeToggle {
            background: linear-gradient(45deg, #fbbf24, #f97316); /* Orange/Yellow in dark mode */
            box-shadow: 0 3px 8px rgba(251, 191, 36, 0.4);
        }
        body.dark #darkModeToggle:hover {
            background: linear-gradient(45deg, #f59e0b, #e65100);
            box-shadow: 0 4px 10px rgba(251, 191, 36, 0.6);
        }

        .status-message {
            font-family: 'Baloo Chettan 2', cursive;
            font-size: 1rem; /* Slightly larger for clarity */
            color: #64748b; /* Slate gray */
            text-align: center;
            min-height: 1.5rem; /* Reserve space to prevent CLS */
            font-weight: 600; /* Bolder status message */
            transition: color 0.5s ease;
        }
        body.dark .status-message {
            color: #cbd5e1; /* Lighter gray in dark mode */
        }
        h1 {
            font-family: 'Baloo Chettan 2', cursive;
            font-weight: 700; /* Extra bold for title */
            color: #312e81; /* Darker blue to match playful theme */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1); /* Subtle text shadow */
            transition: color 0.5s ease, text-shadow 0.5s ease;
        }
        body.dark h1 {
            color: #a78bfa; /* Lighter purple in dark mode */
            text-shadow: 2px 2px 6px rgba(167, 139, 250, 0.3);
        }
        label {
             font-family: 'Baloo Chettan 2', cursive;
             font-weight: 600;
             transition: color 0.5s ease;
        }
        body.dark label {
            color: #d1d5db; /* Lighter text in dark mode */
        }
        body.dark .outputLanguageSelect {
            background-color: #4b5563;
            border-color: #6b7280;
            color: #e5e7eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-4">Mahender, Your AI Assistant!</h1>

        <!-- Dark Mode Toggle Button -->
        <button id="darkModeToggle">
            <i class="fas fa-moon"></i>
        </button>

        <!-- Output Language Selection -->
        <div class="flex flex-col sm:flex-row items-center justify-between p-4 bg-yellow-50 rounded-xl shadow-md border border-yellow-200 transition-colors duration-500">
            <label for="outputLanguage" class="text-lg text-gray-700 mb-2 sm:mb-0 sm:mr-4">I will speak in:</label>
            <select id="outputLanguage" class="form-select block w-full sm:w-1/2 p-2 border border-yellow-300 rounded-lg shadow-sm focus:ring-purple-500 focus:border-purple-500 text-base transition-colors duration-500">
                <!-- Options will be populated by JavaScript -->
            </select>
        </div>

        <!-- Chat History Display -->
        <div id="chatHistory" class="flex flex-col gap-3 h-64 overflow-y-auto p-4 border border-blue-200 rounded-xl bg-blue-50 shadow-inner mb-4 transition-colors duration-500">
            <!-- Chat messages will appear here -->
            <div class="message-box ai-message">Hello! I am Mahender, your AI assistant. Speak something and I will repeat it in your chosen language!</div>
        </div>

        <!-- Status Message -->
        <div id="status" class="status-message">Click the big colorful microphone to start speaking!</div>

        <!-- Action Buttons -->
        <div class="flex justify-center items-center gap-4 mt-4">
            <button id="microphoneButton" class="microphone-btn">
                <i class="fas fa-microphone"></i>
            </button>
            <button id="listenAgainButton" class="listen-again-btn" disabled>
                <i class="fas fa-redo"></i>
            </button>
            <button id="stopButton" class="stop-btn" disabled>
                <i class="fas fa-stop"></i>
            </button>
        </div>

        <!-- Modals for alerts (instead of alert()) -->
        <div id="permissionDeniedModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm text-center">
                <h3 class="text-xl font-semibold text-red-600 mb-4">Oh no! Microphone Blocked!</h3>
                <p class="text-gray-700 mb-6">Please allow microphone access in your browser settings to let me hear you. Then refresh the page!</p>
                <button onclick="document.getElementById('permissionDeniedModal').classList.add('hidden')" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-full">
                    Got it!
                </button>
            </div>
        </div>
        <div id="apiErrorModal" class="fixed inset-0 bg-gray-600 bg-opacity50 hidden items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm text-center">
                <h3 class="text-xl font-semibold text-red-600 mb-4">Oops! Something went wrong!</h3>
                <p id="apiErrorMessage" class="text-gray-700 mb-6">I had trouble talking to the AI. If you're running this on your computer, double-check your special API key. Let's try again!</p>
                <button onclick="document.getElementById('apiErrorModal').classList.add('hidden')" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-full">
                    Okay!
                </button>
            </div>
        </div>

    </div>

    <script type="module">
        // Global variables for Firebase configuration, provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase imports (Minimal imports as Firestore is not used)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Initialize Firebase app if config is available
        let app;
        let auth;
        let userId;

        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            
            // Sign in to Firebase Auth
            (async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                    userId = auth.currentUser?.uid || crypto.randomUUID(); // Get user ID
                    console.log("User ID:", userId);
                } catch (error) {
                    console.error("Firebase authentication error:", error);
                }
            })();
        } else {
            console.warn("Firebase config not available. App will run without Firebase authentication.");
            userId = crypto.randomUUID(); // Generate a random ID if no Firebase auth
        }

        // DOM Elements
        const microphoneButton = document.getElementById('microphoneButton');
        const stopButton = document.getElementById('stopButton');
        const listenAgainButton = document.getElementById('listenAgainButton');
        const darkModeToggle = document.getElementById('darkModeToggle'); // Dark Mode Toggle
        const statusDiv = document.getElementById('status');
        const outputLanguageSelect = document.getElementById('outputLanguage');
        const chatHistoryDiv = document.getElementById('chatHistory');
        const permissionDeniedModal = document.getElementById('permissionDeniedModal');
        const apiErrorModal = document.getElementById('apiErrorModal');
        const apiErrorMessage = document.getElementById('apiErrorMessage');
        const bodyElement = document.body; // Reference to body for dark mode

        // Web Speech API instances
        let recognition;
        let utterance;
        const synth = window.speechSynthesis;

        let isListening = false;
        let lastSpokenText = ""; // Stores the last AI spoken text (translation)

        // --- Language Configuration (India-specific) ---
        const languages = {
            'English (India)': 'en-IN',
            'Hindi': 'hi-IN',
            'Bengali': 'bn-IN',
            'Marathi': 'mr-IN',
            'Telugu': 'te-IN',
            'Tamil': 'ta-IN',
            'Gujarati': 'gu-IN',
            'Kannada': 'kn-IN',
            'Malayalam': 'ml-IN',
            'Punjabi': 'pa-IN',
            'Urdu': 'ur-IN',
            'Odia': 'or-IN',
            'Assamese': 'as-IN',
            'Konkani': 'kok-IN',
            'Kashmiri': 'ks-IN',
            'Maithili': 'mai-IN',
            'Manipuri': 'mni-IN', 
            'Nepali (India)': 'ne-IN', 
            'Sindhi': 'sd-IN', 
            'Sanskrit': 'sa-IN',
            'Dogri': 'doi-IN',
            'Bodo': 'brx-IN',
            'Santali': 'sat-IN',
            'Bhojpuri': 'bho' 
        };

        // Populate language dropdown
        function populateLanguageDropdown() {
            outputLanguageSelect.innerHTML = ''; 
            for (const name in languages) {
                const option = document.createElement('option');
                option.value = languages[name];
                option.textContent = name;
                outputLanguageSelect.appendChild(option);
            }
            // Set default output language (from localStorage or 'en-IN')
            const savedDefaultLang = localStorage.getItem('defaultOutputLanguage');
            if (savedDefaultLang && languages[savedDefaultLang]) { // Check if saved language is valid
                outputLanguageSelect.value = savedDefaultLang;
            } else {
                outputLanguageSelect.value = 'en-IN'; // Fallback
            }
        }

        // Function to update button states
        function updateButtonStates() {
            stopButton.disabled = !synth.speaking; 
            listenAgainButton.disabled = (lastSpokenText === "" || synth.speaking); 
        }

        // Initialize Speech Recognition
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                statusDiv.textContent = "Oh no! Speech recognition is not supported in this browser. Try Chrome or Edge!";
                microphoneButton.disabled = true;
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-IN'; 
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isListening = true;
                microphoneButton.classList.add('listening');
                statusDiv.textContent = 'Listening... What do you want me to repeat?'; 
                microphoneButton.disabled = true; 
                updateButtonStates(); 
            };

            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;
                const confidence = event.results[0][0].confidence;
                const detectedLang = event.results[0].lang || recognition.lang; 

                statusDiv.textContent = `You said: "${transcript}"`;
                addMessageToChat(transcript, 'user'); 
                console.log(`Recognized: "${transcript}" (Confidence: ${confidence}, Detected Lang: ${detectedLang})`);

                // --- DEBUGGING LOGS FOR targetLanguageCode ---
                console.log("--- Debugging Language Selection (within onresult) ---");
                console.log("outputLanguageSelect element:", outputLanguageSelect);
                if (outputLanguageSelect) {
                    console.log("outputLanguageSelect.value:", outputLanguageSelect.value);
                    console.log("outputLanguageSelect.selectedIndex:", outputLanguageSelect.selectedIndex);
                    console.log("outputLanguageSelect.options.length:", outputLanguageSelect.options.length);
                    if (outputLanguageSelect.selectedIndex !== -1 && outputLanguageSelect.options.length > 0) {
                        console.log("outputLanguageSelect.options[selectedIndex].textContent:", outputLanguageSelect.options[outputLanguageSelect.selectedIndex].textContent);
                    } else {
                        console.error("No option selected or options list is empty for outputLanguageSelect (onresult).");
                    }
                } else {
                    console.error("outputLanguageSelect element not found in DOM (onresult)!");
                    statusDiv.textContent = 'Error: Language selector not found. Please refresh.';
                    microphoneButton.disabled = false;
                    updateButtonStates();
                    return; // Stop execution if element is missing
                }
                // --- END DEBUGGING LOGS ---

                const targetLanguageCode = outputLanguageSelect.value;
                const targetLanguageName = outputLanguageSelect.options[outputLanguageSelect.selectedIndex].textContent;

                // Guard against undefined/empty language selection before API call
                if (!targetLanguageCode || targetLanguageCode.trim() === '') {
                    console.error("Error: Target language code is empty or invalid after selection.");
                    apiErrorMessage.textContent = "Oops! The selected output language is invalid. Please choose a language from the list and try again.";
                    apiErrorModal.classList.remove('hidden');
                    apiErrorModal.classList.add('flex');
                    statusDiv.textContent = 'Error: Please select a valid language.';
                    microphoneButton.disabled = false;
                    updateButtonStates();
                    return; // Stop execution
                }


                isListening = false; 
                microphoneButton.classList.remove('listening');
                statusDiv.textContent = 'Translating... Please wait!';
                microphoneButton.disabled = true; 
                updateButtonStates();

                await getAIResponse(transcript, detectedLang, targetLanguageCode, targetLanguageName);
            };

            recognition.onerror = (event) => {
                isListening = false;
                microphoneButton.classList.remove('listening');
                console.error('Speech recognition error:', event.error);
                statusDiv.textContent = 'Oops! Something went wrong with my ears. Try again!';

                if (event.error === 'not-allowed' || event.error === 'permission-denied') {
                    console.error('Microphone access denied. Please ensure your browser has permission to use the microphone for this site.');
                    permissionDeniedModal.classList.remove('hidden');
                    permissionDeniedModal.classList.add('flex');
                } else {
                    console.error('An unexpected speech recognition error occurred.');
                }
                microphoneButton.disabled = false; 
                updateButtonStates();
            };

            recognition.onend = () => {
                if (!isListening && !synth.speaking) { 
                    microphoneButton.classList.remove('listening');
                    statusDiv.textContent = 'Click the big colorful microphone to start speaking!';
                    updateButtonStates();
                }
                console.log("Speech recognition ended.");
            };
        }

        // Function to start speech recognition
        function startListening() {
            if (synth.speaking) {
                synth.cancel(); 
                statusDiv.textContent = 'Speech stopped. Click the big colorful microphone to start speaking!';
            }
            if (!isListening) {
                try {
                    recognition.start();
                } catch (e) {
                    console.error("Error starting recognition:", e);
                    statusDiv.textContent = "Could not start listening. Is your microphone ready?";
                    microphoneButton.classList.remove('listening');
                    microphoneButton.disabled = false; 
                }
            } else {
                recognition.stop(); 
            }
            updateButtonStates();
        }

        // Function to stop speech synthesis
        function stopSpeaking() {
            if (synth.speaking) {
                synth.cancel();
                console.log("Speech synthesis stopped by user.");
                statusDiv.textContent = 'Speech stopped. Click the big colorful microphone to start speaking!';
                microphoneButton.disabled = false; 
            }
            updateButtonStates();
        }

        // Function to listen again
        function listenAgain() {
            if (lastSpokenText && !synth.speaking) {
                statusDiv.textContent = 'Repeating for you...';
                microphoneButton.disabled = true; 
                speakText(lastSpokenText, outputLanguageSelect.value);
            } else {
                console.log("No text to repeat or already speaking.");
            }
            updateButtonStates();
        }

        // Add message to chat history UI (only for user input)
        function addMessageToChat(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message-box', sender === 'user' ? 'user-message' : 'ai-message');
            messageElement.textContent = text;
            chatHistoryDiv.appendChild(messageElement);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight; 
        }

        // --- Gemini API Call ---
        async function getAIResponse(userText, inputLangCode, targetLangCode, targetLanguageName) {
            // IMMEDIATE AND STRICT VALIDATION at the very beginning of getAIResponse
            if (!outputLanguageSelect || !outputLanguageSelect.value || outputLanguageSelect.selectedIndex === -1) {
                console.error("Critical Error: outputLanguageSelect state invalid before API call. outputLanguageSelect:", outputLanguageSelect, "value:", outputLanguageSelect ? outputLanguageSelect.value : "N/A");
                apiErrorMessage.textContent = "Oops! The target language selection is missing or invalid. Please ensure a language is selected and try again.";
                apiErrorModal.classList.remove('hidden');
                apiErrorModal.classList.add('flex');
                statusDiv.textContent = 'Error: Language selection failed. Please try again.';
                microphoneButton.disabled = false;
                updateButtonStates();
                return; // ABORT if language selection is fundamentally broken
            }
            // Re-assign targetLangCode and targetLanguageName from the DOM element directly
            // This ensures we're using the most up-to-date values from the select element.
            targetLangCode = outputLanguageSelect.value;
            targetLanguageName = outputLanguageSelect.options[outputLanguageSelect.selectedIndex].textContent;


            statusDiv.textContent = 'Translating... Please wait!';
            microphoneButton.disabled = true; 
            updateButtonStates();

            // Strict translation prompt
            const prompt = `Translate only the following text into ${targetLanguageName} (${targetLangCode}). Provide nothing else, no greetings, no conversational filler, just the translated text: "${userText}"`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
            };

            // --- DEBUGGING LOG FOR API KEY & PARAMETERS ---
            console.log("--- Debugging API Call (before fetch) ---");
            // NOTE: In Canvas, __api_key__ is provided at runtime automatically.
            // For local testing, ensure 'YOUR_API_KEY_HERE' is replaced with your actual key.
            const apiKey = "AIzaSyCrhSZz8q-SDW11O0lQKttjn_rZGvUydVE"; // Your provided API key inserted here
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            console.log("API Key being used:", apiKey.length > 0 ? "Key provided (length " + apiKey.length + ")" : "API Key is EMPTY! This is normal in Canvas. If running locally, ensure your key is set in the code.");
            console.log("Target Language Code (FINAL value before API call):", targetLangCode); // CRITICAL DEBUG
            console.log("Target Language Name (FINAL value before API call):", targetLanguageName); // CRITICAL DEBUG
            console.log("Prompt to be sent to API:", prompt); // CRITICAL DEBUG
            // --- END DEBUGGING LOG ---

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const result = await response.json();
                let aiResponseText = "Sorry, I couldn't understand or translate that. Can you please try again?";

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    aiResponseText = result.candidates[0].content.parts[0].text;
                } else {
                    console.warn("Gemini response structure unexpected: no candidates or content parts found.", result);
                    // Provide a more specific error message if the API response is malformed
                    aiResponseText = "I received a reply, but it was empty or malformed. Please try again.";
                }

                lastSpokenText = aiResponseText.trim(); 
                statusDiv.textContent = 'Speaking...';
                await speakText(lastSpokenText, targetLangCode); // Using the *latest* targetLangCode

            } catch (error) {
                console.error("Error communicating with Gemini API:", error);
                apiErrorMessage.textContent = `An error occurred: ${error.message}. This might be due to an invalid API key, network issues, or an unexpected API response. If running locally, please ensure your Gemini API key is correctly set in the code (replace the empty string for 'apiKey' with your actual key from Google AI Studio). Please try again.`;
                apiErrorModal.classList.remove('hidden');
                apiErrorModal.classList.add('flex');
                statusDiv.textContent = 'Oh dear! I had a problem. Click microphone to try again.';
            } finally {
                microphoneButton.disabled = false; 
                updateButtonStates(); 
                if (!synth.speaking) { 
                     statusDiv.textContent = 'Click the big colorful microphone to start speaking!';
                }
            }
        }

        // --- Text-to-Speech ---
        async function speakText(text, langCode) {
            return new Promise((resolve) => {
                // Defensive check: If langCode is invalid, resolve immediately
                if (!langCode || langCode.trim() === '') {
                    console.error("speakText error: Invalid language code received:", langCode);
                    statusDiv.textContent = 'Oh dear! Cannot speak due to invalid language setting. Please try again.';
                    microphoneButton.disabled = false;
                    updateButtonStates();
                    resolve();
                    return;
                }

                if (synth.speaking) {
                    synth.cancel();
                }
                
                utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = langCode;

                const voices = synth.getVoices();
                console.log("Available voices when speaking:", voices.length, "voices."); 
                const desiredVoice = voices.find(voice => voice.lang === langCode);
                if (desiredVoice) {
                    utterance.voice = desiredVoice;
                    console.log(`Using voice: ${desiredVoice.name} for language: ${langCode}`); 
                } else {
                    console.warn(`No specific voice found for ${langCode}. Using default browser voice. Total voices available: ${voices.length}.`); 
                }

                utterance.onstart = () => {
                    microphoneButton.disabled = true; 
                    updateButtonStates(); 
                };

                utterance.onend = () => {
                    console.log("Speech synthesis ended.");
                    microphoneButton.disabled = false; 
                    updateButtonStates(); 
                    statusDiv.textContent = 'Click the big colorful microphone to start speaking!';
                    resolve();
                };
                utterance.onerror = (event) => {
                    console.error('SpeechSynthesisUtterance.onerror', event);
                    microphoneButton.disabled = false; 
                    updateButtonStates(); 
                    statusDiv.textContent = 'Oh dear! I had a problem speaking. Click microphone to try again.';
                    resolve();
                };
                synth.speak(utterance);
            });
        }

        // Dark Mode functionality
        function setDarkMode(isDark) {
            if (isDark) {
                bodyElement.classList.add('dark');
                darkModeToggle.querySelector('i').classList.replace('fa-moon', 'fa-sun'); 
            } else {
                bodyElement.classList.remove('dark');
                darkModeToggle.querySelector('i').classList.replace('fa-sun', 'fa-moon'); 
            }
            localStorage.setItem('darkMode', isDark); 
        }

        function toggleDarkMode() {
            const currentMode = bodyElement.classList.contains('dark');
            setDarkMode(!currentMode);
        }

        // Event Listeners for Buttons
        microphoneButton.addEventListener('click', startListening);
        stopButton.addEventListener('click', stopSpeaking);
        listenAgainButton.addEventListener('click', listenAgain);
        darkModeToggle.addEventListener('click', toggleDarkMode); 

        // New: Event listener for when the language selection changes
        outputLanguageSelect.addEventListener('change', (event) => {
            localStorage.setItem('defaultOutputLanguage', event.target.value);
            console.log('Default output language saved:', event.target.value);
        });


        // Initial setup on page load
        window.onload = () => {
            populateLanguageDropdown();
            initSpeechRecognition();
            updateButtonStates(); 

            const savedMode = localStorage.getItem('darkMode');
            if (savedMode === 'true') {
                setDarkMode(true);
            } else {
                setDarkMode(false); 
            }
        };

        // Ensure voices are loaded before trying to set them 
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = populateLanguageDropdown; 
        }
    </script>
</body>
</html>
